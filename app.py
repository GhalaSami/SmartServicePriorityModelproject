import streamlit as st
import pandas as pd
import joblib
import numpy as np
from io import BytesIO

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ù„ ÙˆÙƒÙ„ Artefacts
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
artifacts = joblib.load("final_model.pkl")
model = artifacts["model"]
features = artifacts["features"]
danger_map = artifacts["danger_map"]
weights = artifacts["weights"]
group1_locations = artifacts["group1_locations"]
group2_locations = artifacts["group2_locations"]
group3_locations = artifacts["group3_locations"]
group1_classification = artifacts["group1_classification"]
group2_classification = artifacts["group2_classification"]
group3_classification = artifacts["group3_classification"]

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 2) Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def classify_site_attribute(location):
    if location in group1_locations:
        return group1_classification
    elif location in group2_locations:
        return group2_classification
    elif location in group3_locations:
        return group3_classification
    else:
        return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"

site_rank_map = {
    group2_classification: 3,
    group1_classification: 2,
    group3_classification: 1,
    "ØºÙŠØ± Ù…Ø­Ø¯Ø¯": 0
}

def apply_contextual_boost(row):
    boost = 0
    if row["Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©"] >= 4 and row["Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª"] >= 3:
        boost += 5000
    if row["ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"] == site_rank_map[group2_classification]:
        boost += 3000
    if row["Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†"] > 100000 and row["Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©"] >= 3:
        boost += 4000
    boost += np.random.randint(-100, 100)
    return boost

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 3) ÙˆØ§Ø¬Ù‡Ø© Streamlit
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.set_page_config(page_title="Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª", layout="centered")
st.title("ğŸ“Š Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª")
st.markdown("Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø¨Ù„Ø§ØºØ§Øª (Excel)ØŒ ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§")

uploaded_file = st.file_uploader("ğŸ“ Ø­Ù…Ù‘Ù„ Ù…Ù„Ù Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª (Excel)", type=["xlsx"])
if not uploaded_file:
    st.info("Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ù…Ù„Ù Ø¨Ø¹Ø¯.")
    st.stop()

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 4) Ù‚Ø±Ø§Ø¡Ø© ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
df = pd.read_excel(uploaded_file)

if "Ø¹Ø¯Ø¯ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ù„Ø§Øº" in df.columns:
    df = df.rename(columns={"Ø¹Ø¯Ø¯ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ù„Ø§Øº": "Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª"})

df["Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©"] = df["Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©"].map(danger_map)
df["ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"] = df["Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº"].apply(classify_site_attribute)
df["ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"] = df["ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"].map(site_rank_map)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 5) Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ score ÙˆØ§Ù„Ù€ boost
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
df["score"] = (
    df["Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©"] * weights["Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©"]
    + df["Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª"] * weights["Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª"]
    + df["Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†"] * weights["Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†"]
    + df["ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"] * weights["ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"]
)
df["boost"] = df.apply(apply_contextual_boost, axis=1)
df["score"] += df["boost"]

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 6) Ø§Ù„ØªÙ†Ø¨Ø¤ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
X_new = df[features]
df["Ù…Ø³ØªÙˆÙ‰_Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©"] = model.predict(X_new)

st.success("âœ… ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…! Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ù„Ø£Ø³ÙÙ„:")
st.dataframe(
    df[[
        "Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©",
        "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº",
        "Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†",
        "Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª",
        "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©",
        "ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹",
        "Ù…Ø³ØªÙˆÙ‰_Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©",
    ]]
)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 7) Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ØµÙŠØºØ© Excel
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def to_excel_bytes(df: pd.DataFrame) -> bytes:
    buffer = BytesIO()
    with pd.ExcelWriter(buffer, engine="openpyxl") as writer:
        df.to_excel(writer, index=False)
    return buffer.getvalue()

st.download_button(
    label="â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Excel)",
    data=to_excel_bytes(df),
    file_name="Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©.xlsx",
    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
)
